name: PR Validation

on:
  pull_request:
    branches: [ "main" ]
    types: [opened, synchronize, reopened, ready_for_review]

# Ensure only one workflow runs per PR
concurrency:
  group: pr-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  # Validate PR title follows Conventional Commits
  validate-pr-title:
    name: Validate PR Title
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    
    steps:
      - name: Validate PR title
        uses: amannn/action-semantic-pull-request@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          types: |
            feat
            fix
            docs
            style
            refactor
            perf
            test
            build
            ci
            chore
            revert
          requireScope: false
          subjectPattern: ^[A-Z].+$
          subjectPatternError: |
            The subject "{subject}" found in the pull request title "{title}"
            didn't match the configured pattern. Please ensure that the subject
            starts with an uppercase character.

  # Validate PR has description
  validate-pr-description:
    name: Validate PR Description
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    
    steps:
      - name: Check PR description
        uses: actions/github-script@v7
        with:
          script: |
            const prBody = context.payload.pull_request.body || '';
            const minLength = 50;
            
            if (prBody.trim().length < minLength) {
              core.setFailed(
                `PR description is too short (${prBody.trim().length} chars). ` +
                `Please provide a meaningful description (minimum ${minLength} chars).`
              );
              return;
            }
            
            // Check for required sections (flexible check)
            const hasWhat = /###?\s*What/i.test(prBody);
            const hasWhy = /###?\s*Why/i.test(prBody);
            const hasTesting = /###?\s*Testing/i.test(prBody) || /\[x\].*test/i.test(prBody);
            
            if (!hasWhat || !hasWhy) {
              core.setFailed(
                'PR description is missing required sections. ' +
                'Please use the PR template and fill in: What, Why, and Testing sections.'
              );
              return;
            }
            
            core.info('‚úÖ PR description looks good!');

  # Check PR size
  check-pr-size:
    name: Check PR Size
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    
    steps:
      - name: Check PR size
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const additions = pr.additions || 0;
            const deletions = pr.deletions || 0;
            const totalChanges = additions + deletions;
            
            const maxChanges = 800;
            const warningChanges = 400;
            
            if (totalChanges > maxChanges) {
              core.setFailed(
                `‚ö†Ô∏è  PR is too large (${totalChanges} lines changed). ` +
                `Please consider breaking it into smaller PRs (< ${maxChanges} lines).`
              );
              return;
            }
            
            if (totalChanges > warningChanges) {
              core.warning(
                `‚ö†Ô∏è  PR is getting large (${totalChanges} lines changed). ` +
                `Consider breaking it into smaller PRs for easier review.`
              );
            } else {
              core.info(`‚úÖ PR size is good (${totalChanges} lines changed)`);
            }

  # Lint PR changes
  lint-check:
    name: Lint Check
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup .NET 10
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'
      
      - name: Restore
        run: dotnet restore
      
      - name: Format check
        run: |
          dotnet format --verify-no-changes --verbosity diagnostic
          if [ $? -ne 0 ]; then
            echo "‚ùå Code formatting issues detected. Run 'dotnet format' locally."
            exit 1
          fi
          echo "‚úÖ Code formatting is correct"

  # Security scan
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup .NET 10
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'
      
      - name: Restore
        run: dotnet restore
      
      - name: Check for vulnerable packages
        run: |
          echo "üîç Scanning for vulnerable packages..."
          dotnet list package --vulnerable --include-transitive 2>&1 | tee vulnerability-report.txt
          
          if grep -qi "critical\|high" vulnerability-report.txt; then
            echo "‚ùå Critical or High severity vulnerabilities detected!"
            echo "Please review and update dependencies before merging."
            exit 1
          else
            echo "‚úÖ No critical or high severity vulnerabilities found"
          fi

  # Check for TODO/FIXME without issues
  check-todos:
    name: Check TODOs
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Check for untracked TODOs
        run: |
          # Find TODO/FIXME comments without issue references
          untracked=$(grep -rn "TODO\|FIXME" --include="*.cs" --include="*.fs" --exclude-dir=obj --exclude-dir=bin . | grep -v "#[0-9]" || true)
          
          if [ ! -z "$untracked" ]; then
            echo "‚ö†Ô∏è  Found TODO/FIXME comments without issue references:"
            echo "$untracked"
            echo ""
            echo "Please either:"
            echo "1. Create an issue and reference it (e.g., // TODO #123: description)"
            echo "2. Fix the item in this PR"
            echo "3. Remove the comment if not needed"
            # For now, just warn
            # exit 1
          else
            echo "‚úÖ No untracked TODOs found"
          fi

  # Summary
  pr-validation-summary:
    name: PR Validation Summary
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    needs: [validate-pr-title, validate-pr-description, check-pr-size, lint-check, security-scan, check-todos]
    
    steps:
      - name: All checks passed
        run: |
          echo "üéâ All PR validation checks passed!"
          echo "‚úÖ PR title follows Conventional Commits"
          echo "‚úÖ PR has adequate description"
          echo "‚úÖ PR size is reasonable"
          echo "‚úÖ Code formatting is correct"
          echo "‚úÖ No security vulnerabilities"
          echo "‚úÖ No untracked TODOs"
          echo ""
          echo "Next steps:"
          echo "1. Wait for CD and E2E workflows to complete"
          echo "2. Request review from team members"
          echo "3. Address any feedback"
          echo "4. Merge when approved!"
